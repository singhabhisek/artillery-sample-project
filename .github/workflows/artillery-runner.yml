# =====================================================================
# ğŸ§ª GitHub Actions Workflow: Artillery Load/Stress Test Runner
# =====================================================================
# ğŸ’¡ Purpose:
#Â  Â Automates Artillery performance tests inside GitHub Actions.
#Â  Â Supports selectable environments (test/gamma) & auto-pulls
#Â  Â BASE_URL, API_KEY, and AUTH_HEADER from GitHub Environment Secrets.
#Â  Â Additionally runs a Python dashboard generator to produce
#Â  Â a rich HTML analytics report.
# =====================================================================

name: ğŸ§¨ Run Artillery Tests

# ---------------------------------------------------------------------
# Manual trigger allows running this workflow from GitHub Actions UI
# Defines the input parameters required for manual execution.
# ---------------------------------------------------------------------
on:
Â  workflow_dispatch:
Â  Â  inputs:
Â  Â  Â  environment:
Â  Â  Â  Â  description: "Choose target environment (test or gamma)"
Â  Â  Â  Â  required: true
Â  Â  Â  Â  type: choice
Â  Â  Â  Â  options:
Â  Â  Â  Â  Â  - test
Â  Â  Â  Â  Â  - gamma
Â  Â  Â  test_type:
Â  Â  Â  Â  description: "Choose test type (load, stress, cleanup)"
Â  Â  Â  Â  required: true
Â  Â  Â  Â  type: choice
Â  Â  Â  Â  options:
Â  Â  Â  Â  Â  - load
Â  Â  Â  Â  Â  - stress
Â  Â  Â  Â  Â  - cleanup
Â  Â  Â  script_file:
Â  Â  Â  Â  description: "YAML file from 'scripts/' folder (e.g. login-test.yml)"
Â  Â  Â  Â  required: false
Â  Â  Â  Â  default: "cloudrun-loadtest.yml"
Â  Â  Â  test_name:
Â  Â  Â  Â  description: "Optional custom name for test run"
Â  Â  Â  Â  required: false
Â  Â  Â  cleanup_days:
Â  Â  Â  Â  description: "Delete reports older than X days (for cleanup mode)"
Â  Â  Â  Â  required: false
Â  Â  Â  Â  default: "7"
Â  Â  Â  # Input: Allows selecting the number of concurrent runners (VMs)
Â  Â  Â  runners_to_use:
Â  Â  Â  Â  description: "Number of concurrent runners (VMs) for the test matrix."
Â  Â  Â  Â  required: true
Â  Â  Â  Â  type: choice
Â  Â  Â  Â  options:
Â  Â  Â  Â  Â  - '1'
Â  Â  Â  Â  Â  - '2'
Â  Â  Â  Â  Â  - '4'

# ---------------------------------------------------------------------
# Default environment variables (applies to all jobs)
# ---------------------------------------------------------------------
env:
Â  ARTILLERY_VERSION: "2.0.26"
Â  SCRIPTS_DIR: "./scripts"
Â  DATA_DIR: "./data"
Â  REPORT_DIR: "./artillery-results"

# ---------------------------------------------------------------------
# Main job definition
# ---------------------------------------------------------------------
jobs:
Â  run-artillery:
Â  Â  # ğŸ›‘ KEY CHANGE: Use a job-level 'if' condition to SKIP jobs that
Â  Â  # exceed the requested number of runners. This results in a cleaner
Â  Â  # "Skipped" status instead of a "Failure" status.
Â  Â  if: ${{ matrix.runner_index <= fromJson(github.event.inputs.runners_to_use) }}

Â  Â  # Specifies the type of runner machine to use (GitHub-hosted Ubuntu)
Â  Â  runs-on: ubuntu-latest

Â  Â  # -----------------------------------------------------------------
Â  Â  # Strategy: Defines the matrix for running concurrent runners
Â  Â  # -----------------------------------------------------------------
Â  Â  strategy:
Â  Â  Â  fail-fast: false # Allows all runners to complete even if one fails
Â  Â  Â  matrix:
Â  Â  Â  Â  # Define the maximum number of runners this workflow supports
Â  Â  Â  Â  runner_index: [1, 2, 3, 4]

Â  Â  # Dynamically name the job to show which runner is executing
Â  Â  name: Runner ${{ matrix.runner_index }} of ${{ github.event.inputs.runners_to_use }}

Â  Â  # ğŸ” Tie this job to the selected GitHub Environment for secret access.
Â  Â  environment: ${{ github.event.inputs.environment }}

Â  Â  steps:
Â  Â  Â  # âš ï¸ REMOVED: The previous "Check/Skip Matrix Runner" step is removed
Â  Â  Â  # because the job-level 'if' condition handles skipping more effectively.
Â  Â  Â Â 
Â  Â  Â  # ---------------------------------------------------------------
Â  Â  Â  # â„¹ï¸ Runner Provisioning Details
Â  Â  Â  # ---------------------------------------------------------------
Â  Â  Â  # This step captures and prints the specifications of the
Â  Â  Â  # GitHub-hosted VM (the runner) executing this workflow.
Â  Â  Â  - name: â„¹ï¸ Print Runner Provisioning Details
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  echo "=========================================================="
Â  Â  Â  Â  Â  echo "ğŸ”¥ GITHUB ACTIONS RUNNER VM DETAILS (Artillery Test Host) ğŸ”¥"
Â  Â  Â  Â  Â  echo "=========================================================="
Â  Â  Â  Â  Â  echo "MATRIX RUNNER INDEX: ${{ matrix.runner_index }} of ${{ github.event.inputs.runners_to_use }}"
Â  Â  Â  Â  Â  echo "----------------------------------------------------------"

Â  Â  Â  Â  Â  # 1. VM Provisioned Name/OS
Â  Â  Â  Â  Â  echo "VM/OS Provisioned: ${{ runner.os }} (${{ runner.arch }})"
Â  Â  Â  Â  Â  echo "Kernel/OS Version: $(uname -sro)"

Â  Â  Â  Â  Â  # 2. Capacity (CPU and Memory)
Â  Â  Â  Â  Â  echo "----------------------------------------------------------"
Â  Â  Â  Â  Â  echo "Capacity:"
Â  Â  Â  Â  Â  echo "Â  CPU Cores: $(nproc) (Reported by OS)"

Â  Â  Â  Â  Â  # Calculate total memory (MemTotal is in kB, convert to GB)
Â  Â  Â  Â  Â  MEM_KB=$(grep MemTotal /proc/meminfo | awk '{print $2}')
Â  Â  Â  Â  Â  MEM_GB=$(printf "%.2f" $(echo "$MEM_KB / 1024 / 1024" | bc -l))
Â  Â  Â  Â  Â  echo "Â  Total Memory: ${MEM_GB} GB (Reported by OS)"

Â  Â  Â  Â  Â  # 3 & 4. Public IP and Location (Requires external service)
Â  Â  Â  Â  Â  echo "----------------------------------------------------------"
Â  Â  Â  Â  Â  echo "Network Details (Public IP & Location):"

Â  Â  Â  Â  Â  # Get the public IP address of the runner
Â  Â  Â  Â  Â  PUBLIC_IP=$(curl -s api.ipify.org)
Â  Â  Â  Â  Â  echo "Â  Public IP Used: $PUBLIC_IP"

Â  Â  Â  Â  Â  # Use a geo-IP service (ip-api.com) and jq to get approximate location
Â  Â  Â  Â  Â  LOCATION_INFO=$(curl -s http://ip-api.com/json/$PUBLIC_IP)
Â  Â  Â  Â  Â  CITY=$(echo "$LOCATION_INFO" | jq -r '.city')
Â  Â  Â  Â  Â  REGION=$(echo "$LOCATION_INFO" | jq -r '.regionName')
Â  Â  Â  Â  Â  COUNTRY=$(echo "$LOCATION_INFO" | jq -r '.country')

Â  Â  Â  Â  Â  echo "Â  Approximate Location: $CITY, $REGION, $COUNTRY"
Â  Â  Â  Â  Â  echo "=========================================================="
Â  Â  Â  Â  env:
Â  Â  Â  Â  Â  SHELL: /bin/bash # Use bash for reliable shell commands

Â  Â  Â  # ---------------------------------------------------------------
Â  Â  Â  - name: ğŸ“¥ Checkout Repository
Â  Â  Â  Â  uses: actions/checkout@v4

Â  Â  Â  # ---------------------------------------------------------------
Â  Â  Â  - name: âš™ï¸ Setup Node.js
Â  Â  Â  Â  uses: actions/setup-node@v4
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  node-version: "20"

Â  Â  Â  # ---------------------------------------------------------------
Â  Â  Â  - name: ğŸ“¦ Install Artillery CLI
Â  Â  Â  Â  # Install the specified version of Artillery globally
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  npm install -g artillery@${{ env.ARTILLERY_VERSION }}
Â  Â  Â  Â  Â  # Install metrics-by-endpoint plugin explicitly
Â  Â  Â  - name: ğŸ“¦ Install Artillery CLI Plugin
Â  Â  Â  Â  # Install the required Artillery plugin for detailed metrics
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  npm install --save-dev artillery-plugin-metrics-by-endpoint

Â  Â  Â  # ---------------------------------------------------------------
Â  Â  Â  - name: ğŸ·ï¸ Define Test Name
Â  Â  Â  Â  id: set_name
Â  Â  Â  Â  # Generates a unique test name based on inputs, date, and runner index
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  DATE=$(date +'%d%m%y')
Â  Â  Â  Â  Â  RUNNER_INDEX=${{ matrix.runner_index }}

Â  Â  Â  Â  Â  if [ -n "${{ github.event.inputs.test_name }}" ]; then
Â  Â  Â  Â  Â  Â  BASE_NAME="${{ github.event.inputs.test_name }}"
Â  Â  Â  Â  Â  else
Â  Â  Â  Â  Â  Â  # Derive name from script file
Â  Â  Â  Â  Â  Â  SCRIPT_BASE=$(basename "${{ github.event.inputs.script_file }}" .yml)
Â  Â  Â  Â  Â  Â  BASE_NAME="test-${SCRIPT_BASE}-${DATE}"
Â  Â  Â  Â  Â  fi

Â  Â  Â  Â  Â  # Append runner index to ensure unique report names across concurrent jobs
Â  Â  Â  Â  Â  NAME="${BASE_NAME}-runner-${RUNNER_INDEX}"

Â  Â  Â  Â  Â  echo "test_name=$NAME" >> $GITHUB_OUTPUT
Â  Â  Â  Â  Â  echo "âœ… Test Name: $NAME"

Â  Â  Â  # ---------------------------------------------------------------
Â  Â  Â  - name: ğŸ§¹ Cleanup Old Reports
Â  Â  Â  Â  # Skips if test_type is not 'cleanup'
Â  Â  Â  Â  if: ${{ github.event.inputs.test_type == 'cleanup' }}
Â  Â  Â  Â  # Finds and deletes reports older than the specified days
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  echo "ğŸ§º Deleting reports older than ${{ github.event.inputs.cleanup_days }} days..."
Â  Â  Â  Â  Â  find "${{ env.REPORT_DIR }}" -type f -mtime +${{ github.event.inputs.cleanup_days }} -print -delete || true
Â  Â  Â  Â  Â  echo "âœ… Cleanup complete."

Â  Â  Â  # ---------------------------------------------------------------
Â  Â  Â  - name: ğŸ’¤ Skip Execution in Cleanup Mode
Â  Â  Â  Â  # Skips subsequent steps if in cleanup mode
Â  Â  Â  Â  if: ${{ github.event.inputs.test_type == 'cleanup' }}
Â  Â  Â  Â  run: echo "Cleanup done. Skipping Artillery execution."

Â  Â  Â  # ---------------------------------------------------------------
Â  Â  Â  - name: ğŸš€ Run Artillery Test
Â  Â  Â  Â  # Executes the load/stress test, skipping if test_type is 'cleanup'
Â  Â  Â  Â  if: ${{ github.event.inputs.test_type != 'cleanup' }}
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  # Ensure report directory exists
Â  Â  Â  Â  Â  mkdir -p "${{ env.REPORT_DIR }}"
Â  Â  Â  Â  Â  REPORT_JSON="${{ env.REPORT_DIR }}/${{ steps.set_name.outputs.test_name }}.json"
Â  Â  Â  Â  Â  REPORT_HTML="${{ env.REPORT_DIR }}/${{ steps.set_name.outputs.test_name }}.html"

Â  Â  Â  Â  Â  echo "â–¶ï¸ Running Artillery test script: ${{ github.event.inputs.script_file }} on Runner ${{ matrix.runner_index }}"
Â  Â  Â  Â  Â  echo "ğŸŒ Target URL: ${{ vars.BASE_URL }}"

Â  Â  Â  Â  Â  # Run Artillery with environment variables injected from GitHub secrets/vars
Â  Â  Â  Â  Â  ARTILLERY_TARGET="${{ vars.BASE_URL }}" \
Â  Â  Â  Â  Â  API_KEY="${{ secrets.API_KEY }}" \
Â  Â  Â  Â  Â  AUTH_HEADER="${{ secrets.AUTH_HEADER }}" \
Â  Â  Â  Â  Â  npx artillery run "${{ env.SCRIPTS_DIR }}/${{ github.event.inputs.script_file }}" \
Â  Â  Â  Â  Â  --output "$REPORT_JSON"Â  \
Â  Â  Â  Â  Â  --quiet \
Â  Â  Â  Â  Â  > /dev/null

Â  Â  Â  Â  Â  # Generate the standard HTML report from the JSON output
Â  Â  Â  Â  Â  npx artillery report "$REPORT_JSON" --output "$REPORT_HTML"

Â  Â  Â  # ---------------------------------------------------------------
Â  Â  Â  - name: ğŸ Setup Python
Â  Â  Â  Â  # Set up Python environment for report generation, skip if cleanup
Â  Â  Â  Â  if: ${{ github.event.inputs.test_type != 'cleanup' }}
Â  Â  Â  Â  uses: actions/setup-python@v5
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  python-version: "3.11"

Â  Â  Â  # ---------------------------------------------------------------
Â  Â  Â  - name: ğŸ“¦ Install Python Dependencies
Â  Â  Â  Â  # Install Python packages required for the custom dashboard script
Â  Â  Â  Â  if: ${{ github.event.inputs.test_type != 'cleanup' }}
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  python -m pip install --upgrade pip
Â  Â  Â  Â  Â  pip install pandas pyyaml plotly numpy

Â  Â  Â  # ---------------------------------------------------------------
Â  Â  Â  - name: ğŸ§® Generate Full HTML Dashboard
Â  Â  Â  Â  # Execute custom Python script to create a rich analytics report
Â  Â  Â  Â  if: ${{ github.event.inputs.test_type != 'cleanup' }}
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  echo "ğŸ“Š Running custom Python report generator..."
Â  Â  Â  Â  Â  # Copy script file as config.yml for the Python script
Â  Â  Â  Â  Â  cp "${{ env.SCRIPTS_DIR }}/${{ github.event.inputs.script_file }}" config.yml
Â  Â  Â  Â  Â  python generate_artillery_dashboard.py
Â  Â  Â  Â  env:
Â  Â  Â  Â  Â  INPUT_JSON: "${{ env.REPORT_DIR }}/${{ steps.set_name.outputs.test_name }}.json"
Â  Â  Â  Â  Â  INPUT_YAML: "config.yml"
Â  Â  Â  Â  Â  OUTPUT_HTML: "${{ env.REPORT_DIR }}/${{ steps.set_name.outputs.test_name }}-full.html"

Â  Â  Â  # ---------------------------------------------------------------
Â  Â  Â  - name: ğŸ“¦ Package Results
Â  Â  Â  Â  # Bundle all generated reports and the source script into a zip file
Â  Â  Â  Â  if: ${{ github.event.inputs.test_type != 'cleanup' }}
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  ZIP_FILE="${{ env.REPORT_DIR }}/${{ steps.set_name.outputs.test_name }}.zip"
Â  Â  Â  Â  Â  zip -j "$ZIP_FILE" \
Â  Â  Â  Â  Â  Â  "${{ env.SCRIPTS_DIR }}/${{ github.event.inputs.script_file }}" \
Â  Â  Â  Â  Â  Â  "${{ env.REPORT_DIR }}/${{ steps.set_name.outputs.test_name }}.json" \
Â  Â  Â  Â  Â  Â  "${{ env.REPORT_DIR }}/${{ steps.set_name.outputs.test_name }}.html" \
Â  Â  Â  Â  Â  Â  "${{ env.REPORT_DIR }}/${{ steps.set_name.outputs.test_name }}-full.html"
Â  Â  Â  Â  Â  echo "âœ… Packaged results: $ZIP_FILE"

Â  Â  Â  # ---------------------------------------------------------------
Â  Â  Â  - name: ğŸ“¤ Upload Artifact
Â  Â  Â  Â  # Uploads the packaged zip file as a workflow artifact
Â  Â  Â  Â  if: ${{ github.event.inputs.test_type != 'cleanup' }}
Â  Â  Â  Â  uses: actions/upload-artifact@v4
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  name: "${{ steps.set_name.outputs.test_name }}"
Â  Â  Â  Â  Â  path: "${{ env.REPORT_DIR }}/${{ steps.set_name.outputs.test_name }}.zip"
