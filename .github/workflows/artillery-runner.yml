# =====================================================================
# üß™ GitHub Actions Workflow: Artillery Load/Stress Test Runner
# =====================================================================
# üí° Purpose:
#   Automates running Artillery load/stress tests in GitHub Actions.
#   Supports concurrent runners (VMs), dynamic test environments,
#   and generates both per-runner and merged performance dashboards.
# =====================================================================

name: üß® Run Artillery Tests

# ---------------------------------------------------------------------
# üß≠ Manual Trigger Configuration
# Allows manual execution via GitHub Actions UI with custom parameters.
# ---------------------------------------------------------------------
on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment (test or gamma)"
        required: true
        type: choice
        options:
          - test
          - gamma

      test_type:
        description: "Type of test to run (load, stress, cleanup)"
        required: true
        type: choice
        options:
          - load
          - stress
          - cleanup

      script_file:
        description: "YAML file from 'scripts/' folder (e.g., login-test.yml)"
        required: false
        default: "cloudrun-loadtest.yml"

      test_name:
        description: "Optional custom name for test run"
        required: false

      cleanup_days:
        description: "Delete reports older than X days (cleanup mode)"
        required: false
        default: "7"

      runners_to_use:
        description: "Number of concurrent runners (1‚Äì4)"
        required: true
        type: choice
        options:
          - '1'
          - '2'
          - '4'

# ---------------------------------------------------------------------
# üåç Global Environment Variables
# Common settings for all jobs
# ---------------------------------------------------------------------
env:
  ARTILLERY_VERSION: "2.0.26"
  SCRIPTS_DIR: "./scripts"
  DATA_DIR: "./data"
  REPORT_DIR: "./artillery-results"

# =====================================================================
# JOB 1Ô∏è‚É£: RUN ARTILLERY TESTS PER RUNNER
# =====================================================================
jobs:
  run-artillery:

    # -----------------------------------------------------------------
    # ‚öôÔ∏è Job Condition
    # Skip any matrix job beyond the user-selected number of runners.
    # -----------------------------------------------------------------
    if: ${{ matrix.runner_index <= fromJson(github.event.inputs.runners_to_use) }}

    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    # -----------------------------------------------------------------
    # üß© Matrix Setup
    # Defines up to 4 concurrent runners. Unused ones are skipped.
    # -----------------------------------------------------------------
    strategy:
      fail-fast: false
      matrix:
        runner_index: [1, 2, 3, 4]

    name: Runner ${{ matrix.runner_index }} of ${{ github.event.inputs.runners_to_use }}

    steps:
      # ---------------------------------------------------------------
      # 1Ô∏è‚É£ Print VM/Runner System Details
      # ---------------------------------------------------------------
      - name: ‚ÑπÔ∏è Print Runner Provisioning Details
        shell: bash
        run: |
          echo "=========================================================="
          echo "üî• GITHUB ACTIONS RUNNER DETAILS üî•"
          echo "Runner Index: ${{ matrix.runner_index }} / ${{ github.event.inputs.runners_to_use }}"
          echo "VM OS: ${{ runner.os }} (${{ runner.arch }})"
          echo "Kernel: $(uname -sro)"
          echo "CPU Cores: $(nproc)"
          MEM_KB=$(grep MemTotal /proc/meminfo | awk '{print $2}')
          MEM_GB=$(printf "%.2f" "$(echo "$MEM_KB / 1024 / 1024" | bc -l)")
          echo "Memory: ${MEM_GB} GB"
          PUBLIC_IP=$(curl -s api.ipify.org)
          LOCATION_INFO=$(curl -s http://ip-api.com/json/$PUBLIC_IP)
          CITY=$(echo "$LOCATION_INFO" | jq -r '.city')
          REGION=$(echo "$LOCATION_INFO" | jq -r '.regionName')
          COUNTRY=$(echo "$LOCATION_INFO" | jq -r '.country')
          echo "Public IP: $PUBLIC_IP ($CITY, $REGION, $COUNTRY)"
          echo "=========================================================="

      # ---------------------------------------------------------------
      # 2Ô∏è‚É£ Checkout Code
      # ---------------------------------------------------------------
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      # ---------------------------------------------------------------
      # 3Ô∏è‚É£ Setup Node.js and Install Artillery
      # ---------------------------------------------------------------
      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: üì¶ Install Artillery CLI + Plugin
        run: |
          npm install -g artillery@${{ env.ARTILLERY_VERSION }}
          npm install --save-dev artillery-plugin-metrics-by-endpoint

      # ---------------------------------------------------------------
      # 4Ô∏è‚É£ Generate Unique Test Name per Runner
      # ---------------------------------------------------------------
      - name: üè∑Ô∏è Define Test Name
        id: set_name
        shell: bash
        run: |
          DATE=$(date +'%d%m%y')                    # e.g. 151025
          RANDOM_SUFFIX=$RANDOM                     # Random 0‚Äì32767 for uniqueness
          RUNNER_INDEX=${{ matrix.runner_index }}
          if [ -n "${{ github.event.inputs.test_name }}" ]; then
            BASE_NAME="${{ github.event.inputs.test_name }}"
          else
            SCRIPT_BASE=$(basename "${{ github.event.inputs.script_file }}" .yml)
            BASE_NAME="test-${SCRIPT_BASE}-${DATE}"
          fi
          NAME="${BASE_NAME}-runner-${RUNNER_INDEX}-${RANDOM_SUFFIX}"
          echo "test_name=$NAME" >> $GITHUB_OUTPUT
          echo "‚úÖ Test Name: $NAME"

      # ---------------------------------------------------------------
      # 5Ô∏è‚É£ Cleanup Mode (Deletes Old Reports)
      # ---------------------------------------------------------------
      - name: üßπ Cleanup Old Reports
        if: ${{ github.event.inputs.test_type == 'cleanup' }}
        run: |
          echo "Deleting reports older than ${{ github.event.inputs.cleanup_days }} days..."
          find "${{ env.REPORT_DIR }}" -type f -mtime +${{ github.event.inputs.cleanup_days }} -print -delete || true
          echo "‚úÖ Cleanup complete."

      - name: üí§ Skip Execution in Cleanup Mode
        if: ${{ github.event.inputs.test_type == 'cleanup' }}
        run: echo "Cleanup mode: skipping execution."

      # ---------------------------------------------------------------
      # 6Ô∏è‚É£ Run Artillery Test
      # ---------------------------------------------------------------
      - name: üöÄ Run Artillery Test
        if: ${{ github.event.inputs.test_type != 'cleanup' }}
        shell: bash
        run: |
          mkdir -p "${{ env.REPORT_DIR }}"
          REPORT_JSON="${{ env.REPORT_DIR }}/${{ steps.set_name.outputs.test_name }}.json"
          REPORT_HTML="${{ env.REPORT_DIR }}/${{ steps.set_name.outputs.test_name }}.html"
          echo "‚ñ∂Ô∏è Running Artillery script: ${{ github.event.inputs.script_file }}"
          echo "üåç Target URL: ${{ vars.BASE_URL }}"
          ARTILLERY_TARGET="${{ vars.BASE_URL }}" \
          API_KEY="${{ secrets.API_KEY }}" \
          AUTH_HEADER="${{ secrets.AUTH_HEADER }}" \
          npx artillery run "${{ env.SCRIPTS_DIR }}/${{ github.event.inputs.script_file }}" \
          --output "$REPORT_JSON" --quiet
          npx artillery report "$REPORT_JSON" --output "$REPORT_HTML"

      # ---------------------------------------------------------------
      # 7Ô∏è‚É£ Setup Python and Generate Runner Dashboard
      # ---------------------------------------------------------------
      - name: üêç Setup Python
        if: ${{ github.event.inputs.test_type != 'cleanup' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: üì¶ Install Python Dependencies
        if: ${{ github.event.inputs.test_type != 'cleanup' }}
        run: |
          python -m pip install --upgrade pip
          pip install pandas pyyaml plotly numpy

      - name: üßÆ Generate Full HTML Dashboard
        if: ${{ github.event.inputs.test_type != 'cleanup' }}
        shell: bash
        run: |
          cp "${{ env.SCRIPTS_DIR }}/${{ github.event.inputs.script_file }}" config.yml
          python generate_artillery_dashboard.py \
            --json "${{ env.REPORT_DIR }}/${{ steps.set_name.outputs.test_name }}.json" \
            --yaml config.yml \
            --output "${{ env.REPORT_DIR }}/${{ steps.set_name.outputs.test_name }}-full.html"

      # ---------------------------------------------------------------
      # 8Ô∏è‚É£ Package Per-Runner Artifacts
      # ---------------------------------------------------------------
      - name: üì¶ Package Results
        if: ${{ github.event.inputs.test_type != 'cleanup' }}
        shell: bash
        run: |
          ZIP_FILE="${{ env.REPORT_DIR }}/${{ steps.set_name.outputs.test_name }}.zip"
          zip -j "$ZIP_FILE" \
            "${{ env.SCRIPTS_DIR }}/${{ github.event.inputs.script_file }}" \
            "${{ env.REPORT_DIR }}/${{ steps.set_name.outputs.test_name }}.json" \
            "${{ env.REPORT_DIR }}/${{ steps.set_name.outputs.test_name }}.html" \
            "${{ env.REPORT_DIR }}/${{ steps.set_name.outputs.test_name }}-full.html"
          echo "‚úÖ Packaged results: $ZIP_FILE"

      - name: üì§ Upload Artifact
        if: ${{ github.event.inputs.test_type != 'cleanup' }}
        uses: actions/upload-artifact@v4
        with:
          name: "${{ steps.set_name.outputs.test_name }}"
          path: "${{ env.REPORT_DIR }}/${{ steps.set_name.outputs.test_name }}.zip"

  # =====================================================================
  # JOB 2Ô∏è‚É£: AGGREGATE RESULTS AND GENERATE MERGED DASHBOARD
  # =====================================================================
  aggregate-reports:
    if: ${{ github.event.inputs.test_type != 'cleanup' }}
    needs: [run-artillery]
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      # ---------------------------------------------------------------
      # 1Ô∏è‚É£ Download all runner artifacts (ZIPs)
      # ---------------------------------------------------------------
      - name: üì• Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artillery-results

      # ---------------------------------------------------------------
      # 2Ô∏è‚É£ Extract each ZIP into separate folder (avoid YAML overwrites)
      # ---------------------------------------------------------------
      - name: üß© Extract ZIPs per runner
        id: extract
        shell: bash
        run: |
          mkdir -p combined-results
          for zipfile in artillery-results/*.zip; do
            foldername=$(basename "$zipfile" .zip)
            mkdir -p combined-results/"$foldername"
            unzip -o "$zipfile" -d combined-results/"$foldername" > /dev/null
          done
          echo "‚úÖ All ZIPs extracted into separate folders."

      # ---------------------------------------------------------------
      # 3Ô∏è‚É£ Collect all JSON filenames into comma-separated list
      # ---------------------------------------------------------------
      - name: üìù Collect JSON filenames for Python
        id: collect_jsons
        shell: bash
        run: |
          JSON_FILES=""
          for folder in combined-results/*; do
            json_file=$(ls "$folder"/*.json)
            JSON_FILES="$JSON_FILES,$(basename "$json_file")"
          done
          JSON_FILES="${JSON_FILES#,}"
          echo "json_files=$JSON_FILES" >> $GITHUB_OUTPUT
          echo "‚úÖ JSON files to pass: $JSON_FILES"

      # ---------------------------------------------------------------
      # 4Ô∏è‚É£ Setup Python and Generate Combined Dashboard
      # ---------------------------------------------------------------
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: üì¶ Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas pyyaml plotly numpy

      - name: üßÆ Generate Combined Dashboard
        shell: bash
        run: |
          cp combined-results/*/*.yml config.yml
          python ../generate_artillery_dashboard.py \
            --json "${{ steps.collect_jsons.outputs.json_files }}" \
            --yaml config.yml \
            --output "../merged-dashboard.html"
          echo "‚úÖ Merged dashboard generated: merged-dashboard.html"

      # ---------------------------------------------------------------
      # 5Ô∏è‚É£ Upload Merged Dashboard Artifact
      # ---------------------------------------------------------------
      - name: üì§ Upload Combined Dashboard
        uses: actions/upload-artifact@v4
        with:
          name: merged-artillery-dashboard
          path: merged-dashboard.html
