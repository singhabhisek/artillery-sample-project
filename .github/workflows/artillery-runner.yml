name: Artillery Load Test (Multi-Runner)

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: "Choose test type (e.g., load/cleanup)"
        required: true
        type: choice
        options:
          - load
          - stress
          - cleanup
      runners_to_use:
        description: "Number of parallel runners to use (1‚Äì4)"
        required: true
        type: choice
        options:
          - '1'
          - '2'
          - '4'
      scenario_file:
        description: "YAML file for Artillery test (e.g., cloudrun-loadtest.yml)"
        required: true
        default: "cloudrun-loadtest.yml"
      cleanup_days:
        description: "Delete reports older than X days (cleanup mode)"
        required: false
        default: "7"

env:
  ARTILLERY_VERSION: "2.0.26"
  SCRIPTS_DIR: "./scripts"
  DATA_DIR: "./data"
  REPORT_DIR: "./artillery-results"

jobs:
  # =========================================================
  # 1Ô∏è‚É£ Run Artillery on Multiple Runners
  # =========================================================
  run-artillery:
    name: Run Artillery - Runner ${{ matrix.runner_index }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        runner_index: [1, 2, 3, 4]

    steps:
      # Checkout the repo so scripts and YAML exist
      - name: üßæ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Skip unused runners
      - name: üõë Skip unused runner jobs
        if: ${{ matrix.runner_index > fromJSON(github.event.inputs.runners_to_use) }}
        continue-on-error: true
        run: |
          echo "Skipping runner ${{ matrix.runner_index }}"
          exit 0

      # Ensure scenario YAML exists
      - name: üîç Check scenario YAML exists
        if: ${{ matrix.runner_index <= fromJSON(github.event.inputs.runners_to_use) }}
        shell: bash
        run: |
          if [ ! -f "${{ env.SCRIPTS_DIR }}/${{ github.event.inputs.scenario_file }}" ]; then
            echo "‚ùå Scenario file not found"
            exit 1
          else
            echo "‚úÖ Found scenario file"
          fi

      # Setup Node.js for Artillery
      - name: üß© Setup Node.js
        if: ${{ matrix.runner_index <= fromJSON(github.event.inputs.runners_to_use) }}
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # Install Artillery and plugin
      - name: ‚öôÔ∏è Install Artillery + Plugin
        if: ${{ matrix.runner_index <= fromJSON(github.event.inputs.runners_to_use) }}
        run: |
          npm install -g artillery@${{ env.ARTILLERY_VERSION }}
          npm install --save-dev artillery-plugin-metrics-by-endpoint
          artillery --version

      # Run Artillery and generate JSON + HTML
      - name: üöÄ Run Artillery Test
        if: ${{ matrix.runner_index <= fromJSON(github.event.inputs.runners_to_use) }}
        id: run_test
        shell: bash
        run: |
          mkdir -p "${{ env.REPORT_DIR }}"
          TEST_NAME="test-${{ github.event.inputs.test_type }}"
          TIMESTAMP=$(date +%d%m%y)
          RANDOM_SUFFIX=$(head /dev/urandom | tr -dc a-z0-9 | head -c 6)
          RESULT_JSON="${TEST_NAME}-${TIMESTAMP}-runner-${{ matrix.runner_index }}-${RANDOM_SUFFIX}.json"
          RESULT_HTML="${TEST_NAME}-${TIMESTAMP}-runner-${{ matrix.runner_index }}-${RANDOM_SUFFIX}-full.html"

          echo "üß™ Running test: $RESULT_JSON"

          ARTILLERY_TARGET="${{ vars.BASE_URL }}" \
          API_KEY="${{ secrets.API_KEY }}" \
          AUTH_HEADER="${{ secrets.AUTH_HEADER }}" \
          npx artillery run "${{ env.SCRIPTS_DIR }}/${{ github.event.inputs.scenario_file }}" \
          --output "${{ env.REPORT_DIR }}/$RESULT_JSON" --quiet

          npx artillery report "${{ env.REPORT_DIR }}/$RESULT_JSON" --output "${{ env.REPORT_DIR }}/$RESULT_HTML"

          echo "result_json=$RESULT_JSON" >> $GITHUB_OUTPUT
          echo "result_html=$RESULT_HTML" >> $GITHUB_OUTPUT

      # Package runner results
      - name: üì¶ Package Artillery Results
        if: ${{ matrix.runner_index <= fromJSON(github.event.inputs.runners_to_use) }}
        run: |
          ZIP_NAME="runner-${{ matrix.runner_index }}-results.zip"
          mkdir -p upload
          zip -r "upload/$ZIP_NAME" "${{ env.REPORT_DIR }}/$RESULT_JSON" "${{ env.REPORT_DIR }}/logs" || true
          echo "Packaged ZIP: upload/$ZIP_NAME"

      # Upload runner ZIP
      - name: üì§ Upload Artillery Results
        if: ${{ matrix.runner_index <= fromJSON(github.event.inputs.runners_to_use) }}
        uses: actions/upload-artifact@v4
        with:
          name: artillery-results-runner-${{ matrix.runner_index }}
          path: upload/*.zip
        continue-on-error: true

  # =========================================================
  # 2Ô∏è‚É£ Aggregate reports and generate consolidated ZIP
  # =========================================================
  aggregate-reports:
    if: ${{ github.event.inputs.test_type != 'cleanup' }}
    needs: run-artillery
    runs-on: ubuntu-latest

    steps:
      - name: üßæ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Debug workspace
      - name: üîç Debug Workspace & Scripts
        shell: bash
        run: |
          echo "Current directory: $(pwd)"
          ls -R
          ls -R ./scripts || echo "Scripts folder not found"
          if [ -f "${GITHUB_WORKSPACE}/generate_artillery_dashboard.py" ]; then
            echo "‚úÖ Python dashboard script found"
          else
            echo "‚ùå Python dashboard script not found"
          fi

      # Download runner artifacts
      - name: üì• Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artillery-results

      - name: üß© Extract ZIPs
        shell: bash
        run: |
          mkdir -p combined-results
          for zipfile in artillery-results/**/*.zip; do
            [ -f "$zipfile" ] || continue
            foldername=$(basename "$zipfile" .zip)
            mkdir -p combined-results/"$foldername"
            unzip -o "$zipfile" -d combined-results/"$foldername" > /dev/null
          done

      # Collect JSONs
      - name: üìù Collect JSON filenames
        id: collect_jsons
        shell: bash
        run: |
          JSON_FILES=$(find combined-results -name '*.json' -type f | paste -sd "," -)
          if [ -z "$JSON_FILES" ]; then
            echo "‚ö†Ô∏è No JSON files found!"
            echo "json_files=" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "json_files=$JSON_FILES" >> $GITHUB_OUTPUT
          echo "$JSON_FILES" | tr ',' '\n'

      # Setup Python
      - name: üêç Setup Python
        if: ${{ steps.collect_jsons.outputs.json_files != '' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # Install Python dependencies
      - name: üì¶ Install Python Dependencies
        if: ${{ steps.collect_jsons.outputs.json_files != '' }}
        run: |
          python -m pip install --upgrade pip
          pip install pandas pyyaml plotly numpy

      # Generate merged HTML dashboard
      - name: üßÆ Generate Combined Dashboard
        if: ${{ steps.collect_jsons.outputs.json_files != '' }}
        shell: bash
        run: |
          SCENARIO_FILE="${{ env.SCRIPTS_DIR }}/${{ github.event.inputs.scenario_file }}"
          python "${GITHUB_WORKSPACE}/generate_artillery_dashboard.py" \
            --json "${{ steps.collect_jsons.outputs.json_files }}" \
            --yaml "$SCENARIO_FILE" \
            --output "merged-dashboard.html"

      - name: üì§ Upload Combined Dashboard
        if: ${{ steps.collect_jsons.outputs.json_files != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: merged-artillery-dashboard
          path: merged-dashboard.html

      # Create consolidated ZIP (all runner ZIPs + dashboard)
      - name: üì¶ Create Consolidated Report ZIP
        if: ${{ steps.collect_jsons.outputs.json_files != '' }}
        shell: bash
        run: |
          mkdir -p final-report
          cp artillery-results/**/*.zip final-report/ || true
          cp merged-dashboard.html final-report/ || true
          CONSOLIDATED_ZIP="artillery-final-report.zip"
          cd final-report
          zip -r "../$CONSOLIDATED_ZIP" ./*
          cd ..
          echo "‚úÖ Consolidated ZIP created: $CONSOLIDATED_ZIP"

      - name: üì§ Upload Consolidated Report
        if: ${{ steps.collect_jsons.outputs.json_files != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: artillery-final-report
          path: artillery-final-report.zip
