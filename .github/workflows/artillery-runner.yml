name: Artillery Load Test (Multi-Runner)

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: "Choose test type (e.g., load/stress/cleanup)"
        required: true
        type: choice
        options:
          - load
          - stress
          - cleanup
      environment:
        description: "Environment to run test on (test/prod)"
        required: true
        type: choice
        options:
          - test
          - prod
      runners_to_use:
        description: "Number of parallel runners to use (1â€“4)"
        required: true
        type: choice
        options:
          - '1'
          - '2'
          - '4'
      scenario_file:
        description: "Artillery YAML scenario (e.g., cloudrun-loadtest.yml)"
        required: true
        default: "cloudrun-loadtest.yml"
      cleanup_days:
        description: "Delete reports older than X days (cleanup mode)"
        required: false
        default: "7"

# =========================================================
# ğŸŒ Global environment variables
# =========================================================
env:
  ARTILLERY_VERSION: "2.0.26"
  SCRIPTS_DIR: "./scripts"
  DATA_DIR: "./data"
  REPORT_DIR: "./artillery-results"

# =========================================================
# 1ï¸âƒ£ Job: Run Artillery across multiple runners in parallel
# =========================================================
jobs:
  run-artillery:
    name: Run Artillery - Runner ${{ matrix.runner_index }}
    runs-on: ubuntu-latest

    # Up to 4 parallel runners (controlled by user input)
    strategy:
      fail-fast: false
      matrix:
        runner_index: [1, 2, 3, 4]

    steps:
      # ---------------------------------------------------------------
      # Step 0: Checkout the repository so ./scripts folder is available
      # ---------------------------------------------------------------
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ---------------------------------------------------------------
      # Step 1: Skip unused runners gracefully (âœ… green instead of âŒ)
      # ---------------------------------------------------------------
      - name: ğŸ›‘ Skip unused runner jobs
        if: ${{ matrix.runner_index > fromJson(github.event.inputs.runners_to_use) }}
        continue-on-error: true
        run: |
          echo "Skipping runner ${{ matrix.runner_index }} (limit = ${{ github.event.inputs.runners_to_use }})"
          exit 0

      # ---------------------------------------------------------------
      # Step 2: Validate the scenario YAML exists before proceeding
      # ---------------------------------------------------------------
      - name: ğŸ” Validate Scenario YAML Exists
        if: ${{ matrix.runner_index <= fromJson(github.event.inputs.runners_to_use) }}
        shell: bash
        run: |
          FILE_PATH="${{ env.SCRIPTS_DIR }}/${{ github.event.inputs.scenario_file }}"
          echo "ğŸ” Checking for scenario file: $FILE_PATH"
          if [ ! -f "$FILE_PATH" ]; then
            echo "âŒ Scenario file not found at: $FILE_PATH"
            echo "ğŸ›‘ Please ensure the YAML file exists in the 'scripts/' folder."
            exit 1
          fi
          echo "âœ… Scenario file found."

      # ---------------------------------------------------------------
      # Step 3: Validate all required secrets and variables are present
      # ---------------------------------------------------------------
      - name: ğŸ” Validate Required Secrets and Variables
        if: ${{ matrix.runner_index <= fromJson(github.event.inputs.runners_to_use) }}
        shell: bash
        run: |
          missing=false
          echo "ğŸ” Validating required GitHub secrets and variables..."
          if [ -z "${{ secrets.API_KEY }}" ]; then
            echo "âŒ Missing secret: API_KEY"; missing=true
          else
            echo "âœ… Secret: API_KEY is set."
          fi
          if [ -z "${{ secrets.AUTH_HEADER }}" ]; then
            echo "âŒ Missing secret: AUTH_HEADER"; missing=true
          else
            echo "âœ… Secret: AUTH_HEADER is set."
          fi
          if [ -z "${{ vars.BASE_URL }}" ]; then
            echo "âŒ Missing variable: BASE_URL"; missing=true
          else
            echo "âœ… Variable: BASE_URL is set."
          fi
          if [ "$missing" = true ]; then
            echo "ğŸ›‘ One or more required secrets/variables are missing. Exiting."
            exit 1
          fi

      # ---------------------------------------------------------------
      # Step 4: Print basic system information for debugging
      # ---------------------------------------------------------------
      - name: â„¹ï¸ Print Runner Provisioning Details
        if: ${{ matrix.runner_index <= fromJson(github.event.inputs.runners_to_use) }}
        shell: bash
        run: |
          echo "================== RUNNER DETAILS =================="
          echo "Runner index: ${{ matrix.runner_index }} / ${{ github.event.inputs.runners_to_use }}"
          echo "OS: ${{ runner.os }} (${{ runner.arch }})"
          echo "Kernel: $(uname -sro)"
          echo "CPU cores: $(nproc)"
          MEM_KB=$(grep MemTotal /proc/meminfo | awk '{print $2}')
          MEM_GB=$(printf "%.2f" "$(echo "$MEM_KB / 1024 / 1024" | bc -l)")
          echo "Memory: ${MEM_GB} GB"
          echo "Public IP: $(curl -s api.ipify.org)"
          echo "===================================================="

      # ---------------------------------------------------------------
      # Step 5: Setup Node.js (required for Artillery)
      # ---------------------------------------------------------------
      - name: ğŸ§© Setup Node.js
        if: ${{ matrix.runner_index <= fromJson(github.event.inputs.runners_to_use) }}
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # ---------------------------------------------------------------
      # Step 6: Install Artillery and its plugin
      # ---------------------------------------------------------------
      - name: âš™ï¸ Install Artillery + Plugin
        if: ${{ matrix.runner_index <= fromJson(github.event.inputs.runners_to_use) }}
        run: |
          npm install -g artillery@${{ env.ARTILLERY_VERSION }}
          npm install --save-dev artillery-plugin-metrics-by-endpoint
          artillery --version

      # ---------------------------------------------------------------
      # Step 7: List workspace contents (for debug only)
      # ---------------------------------------------------------------
      - name: ğŸ§ª Debug List workspace & scripts folder
        if: ${{ matrix.runner_index <= fromJson(github.event.inputs.runners_to_use) }}
        shell: bash
        run: |
          echo "Working directory: $(pwd)"
          echo "All files in workspace:"
          ls -R .
          echo "Contents of ./scripts folder:"
          ls -R ./scripts || echo "scripts folder not found!"

      # ---------------------------------------------------------------
      # Step 8: Run Artillery test with unique result names
      # ---------------------------------------------------------------
      - name: ğŸš€ Run Artillery Test
        if: ${{ matrix.runner_index <= fromJson(github.event.inputs.runners_to_use) }}
        id: run_test
        shell: bash
        run: |
          mkdir -p artillery-results
          TEST_NAME="test-${{ github.event.inputs.test_type }}-${{ github.event.inputs.environment }}"
          TIMESTAMP=$(date +%d%m%y)
          RANDOM_SUFFIX=$(head /dev/urandom | tr -dc a-z0-9 | head -c 6)
          RESULT_JSON="${TEST_NAME}-${TIMESTAMP}-runner-${{ matrix.runner_index }}-${RANDOM_SUFFIX}.json"
          RESULT_HTML="${TEST_NAME}-${TIMESTAMP}-runner-${{ matrix.runner_index }}-${RANDOM_SUFFIX}-full.html"

          echo "ğŸ§ª Running test: ${RESULT_JSON}"
          ARTILLERY_TARGET="${{ vars.BASE_URL }}" \
          API_KEY="${{ secrets.API_KEY }}" \
          AUTH_HEADER="${{ secrets.AUTH_HEADER }}" \
          npx artillery run "${{ env.SCRIPTS_DIR }}/${{ github.event.inputs.scenario_file }}" \
          --output "artillery-results/${RESULT_JSON}" --quiet

          npx artillery report "artillery-results/${RESULT_JSON}" --output "artillery-results/${RESULT_HTML}"
          echo "result_json=${RESULT_JSON}" >> $GITHUB_OUTPUT
          echo "result_html=${RESULT_HTML}" >> $GITHUB_OUTPUT

      # ---------------------------------------------------------------
      # Step 9: Package test results into a ZIP per runner
      # ---------------------------------------------------------------
      - name: ğŸ“¦ Package Artillery Results
        if: ${{ matrix.runner_index <= fromJson(github.event.inputs.runners_to_use) }}
        run: |
          TEST_NAME="test-${{ github.event.inputs.test_type }}-${{ github.event.inputs.environment }}"
          ZIP_NAME="${TEST_NAME}-${{ matrix.runner_index }}.zip"
          mkdir -p upload
          zip -r "upload/${ZIP_NAME}" artillery-results/*${{ matrix.runner_index }}*.json artillery-results/*${{ matrix.runner_index }}*.html ${{ github.event.inputs.scenario_file }}
          echo "Packaged ZIP: upload/${ZIP_NAME}"

      # ---------------------------------------------------------------
      # Step 10: Upload the ZIP as an artifact
      # ---------------------------------------------------------------
      - name: ğŸ“¤ Upload Artillery Results
        if: ${{ matrix.runner_index <= fromJson(github.event.inputs.runners_to_use) }}
        uses: actions/upload-artifact@v4
        with:
          name: artillery-results-runner-${{ matrix.runner_index }}
          path: upload/*.zip

# =========================================================
# 2ï¸âƒ£ Job: Aggregate All Runner Reports (post-processing)
# =========================================================
  aggregate-reports:
    if: ${{ github.event.inputs.test_type != 'cleanup' }}
    needs: [run-artillery]
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: ğŸ“¥ Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artillery-results

      - name: ğŸ§© Extract ZIPs per runner
        id: extract
        shell: bash
        run: |
          mkdir -p combined-results
          for zipfile in artillery-results/**/*.zip; do
            foldername=$(basename "$zipfile" .zip)
            mkdir -p combined-results/"$foldername"
            unzip -o "$zipfile" -d combined-results/"$foldername" > /dev/null
          done
          echo "âœ… Extracted all runner ZIPs into unique subfolders."

      - name: ğŸ“ Collect JSON filenames for Python
        id: collect_jsons
        shell: bash
        run: |
          JSON_FILES=""
          for folder in combined-results/*; do
            json_file=$(ls "$folder"/*.json | head -n 1)
            if [ -n "$json_file" ]; then
              JSON_FILES="$JSON_FILES,$(basename "$json_file")"
            fi
          done
          JSON_FILES="${JSON_FILES#,}"
          echo "json_files=$JSON_FILES" >> $GITHUB_OUTPUT
          echo "âœ… JSON files to pass: $JSON_FILES"

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ“¦ Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas pyyaml plotly numpy

      - name: ğŸ§® Generate Combined Dashboard
        shell: bash
        run: |
          cp combined-results/*/*.yml config.yml
          python ../generate_artillery_dashboard.py \
            --json "${{ steps.collect_jsons.outputs.json_files }}" \
            --yaml config.yml \
            --output "../merged-dashboard.html"
          echo "âœ… Merged dashboard generated: merged-dashboard.html"

      - name: ğŸ“¤ Upload Combined Dashboard
        uses: actions/upload-artifact@v4
        with:
          name: merged-artillery-dashboard
          path: merged-dashboard.html
