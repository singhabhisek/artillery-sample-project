# =====================================================================
# 🧪 GitHub Actions Workflow: Artillery Load/Stress Test Runner
# =====================================================================
# 💡 Purpose:
#   Automates Artillery performance/load/stress tests inside GitHub Actions.
#   Allows selecting:
#     - Environment: (test / gamma)
#     - Test Type: (load / stress / cleanup)
#     - Number of concurrent runners (1–4)
#   Pulls environment variables like BASE_URL, API_KEY, and AUTH_HEADER
#   from GitHub Environment Secrets.
#   Optionally generates a rich HTML analytics dashboard via Python.
# =====================================================================

name: 🧨 Run Artillery Tests

# ---------------------------------------------------------------------
# Trigger: Manual run from GitHub Actions UI with user-defined inputs
# ---------------------------------------------------------------------
on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Choose target environment (test or gamma)"
        required: true
        type: choice
        options:
          - test
          - gamma
      test_type:
        description: "Choose test type (load, stress, cleanup)"
        required: true
        type: choice
        options:
          - load
          - stress
          - cleanup
      script_file:
        description: "YAML file from 'scripts/' folder (e.g. login-test.yml)"
        required: false
        default: "cloudrun-loadtest.yml"
      test_name:
        description: "Optional custom name for test run"
        required: false
      cleanup_days:
        description: "Delete reports older than X days (used in cleanup mode)"
        required: false
        default: "7"
      runners_to_use:
        description: "Number of concurrent runners (VMs) for the test matrix"
        required: true
        type: choice
        options:
          - '1'
          - '2'
          - '4'

# ---------------------------------------------------------------------
# Default environment variables used across all jobs
# ---------------------------------------------------------------------
env:
  ARTILLERY_VERSION: "2.0.26"
  SCRIPTS_DIR: "./scripts"
  DATA_DIR: "./data"
  REPORT_DIR: "./artillery-results"

# ---------------------------------------------------------------------
# Main Job: Executes Artillery Tests across multiple concurrent runners
# ---------------------------------------------------------------------
jobs:
  run-artillery:
    # Each matrix instance runs on a separate GitHub-hosted Ubuntu VM
    runs-on: ubuntu-latest
    # Attach the workflow to the selected GitHub Environment for secrets
    environment: ${{ github.event.inputs.environment }}

    # ---------------------------------------------------------------
    # Matrix Strategy: Allows concurrent test runners
    # - Up to 4 runners supported
    # - We'll skip unused runners dynamically
    # ---------------------------------------------------------------
    strategy:
      fail-fast: false
      matrix:
        runner_index: [1, 2, 3, 4]

    # Dynamic name to easily identify which runner is which
    name: Runner ${{ matrix.runner_index }} of ${{ github.event.inputs.runners_to_use }}

    steps:
      # ---------------------------------------------------------------
      # ✅ Step 1: Skip Unused Runners
      # ---------------------------------------------------------------
      # GitHub Actions does NOT allow using `matrix.*` in a job-level if.
      # Therefore, we do the skipping at the first step using a condition.
      # If the current runner index is greater than requested, exit early.
      # ---------------------------------------------------------------
      - name: 🛑 Skip Unused Runners
        if: ${{ matrix.runner_index > fromJson(github.event.inputs.runners_to_use) }}
        run: |
          echo "Skipping this runner — index ${{ matrix.runner_index }} > requested ${{ github.event.inputs.runners_to_use }}"
          exit 0

      # ---------------------------------------------------------------
      # ℹ️ Print information about the GitHub-hosted runner
      # ---------------------------------------------------------------
      - name: ℹ️ Print Runner Provisioning Details
        shell: bash
        run: |
          echo "=========================================================="
          echo "🔥 GITHUB ACTIONS RUNNER VM DETAILS (Artillery Test Host) 🔥"
          echo "=========================================================="
          echo "MATRIX RUNNER INDEX: ${{ matrix.runner_index }} of ${{ github.event.inputs.runners_to_use }}"
          echo "----------------------------------------------------------"
          echo "VM/OS Provisioned: ${{ runner.os }} (${{ runner.arch }})"
          echo "Kernel/OS Version: $(uname -sro)"
          echo "----------------------------------------------------------"
          echo "Capacity:"
          echo "  CPU Cores: $(nproc)"
          MEM_KB=$(grep MemTotal /proc/meminfo | awk '{print $2}')
          MEM_GB=$(printf "%.2f" "$(echo "$MEM_KB / 1024 / 1024" | bc -l)")
          echo "  Total Memory: ${MEM_GB} GB"
          echo "----------------------------------------------------------"
          echo "Network Details:"
          PUBLIC_IP=$(curl -s api.ipify.org)
          echo "  Public IP Used: $PUBLIC_IP"
          LOCATION_INFO=$(curl -s http://ip-api.com/json/$PUBLIC_IP)
          CITY=$(echo "$LOCATION_INFO" | jq -r '.city')
          REGION=$(echo "$LOCATION_INFO" | jq -r '.regionName')
          COUNTRY=$(echo "$LOCATION_INFO" | jq -r '.country')
          echo "  Approximate Location: $CITY, $REGION, $COUNTRY"
          echo "=========================================================="

      # ---------------------------------------------------------------
      # 📥 Step 2: Checkout the repository
      # ---------------------------------------------------------------
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4

      # ---------------------------------------------------------------
      # ⚙️ Step 3: Setup Node.js and Install Artillery
      # ---------------------------------------------------------------
      - name: ⚙️ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: 📦 Install Artillery CLI + Plugin
        run: |
          npm install -g artillery@${{ env.ARTILLERY_VERSION }}
          npm install --save-dev artillery-plugin-metrics-by-endpoint

      # ---------------------------------------------------------------
      # 🏷️ Step 4: Define a Unique Test Name
      # ---------------------------------------------------------------
      - name: 🏷️ Define Test Name
        id: set_name
        shell: bash
        run: |
          DATE=$(date +'%d%m%y')
          RUNNER_INDEX=${{ matrix.runner_index }}

          if [ -n "${{ github.event.inputs.test_name }}" ]; then
            BASE_NAME="${{ github.event.inputs.test_name }}"
          else
            SCRIPT_BASE=$(basename "${{ github.event.inputs.script_file }}" .yml)
            BASE_NAME="test-${SCRIPT_BASE}-${DATE}"
          fi

          NAME="${BASE_NAME}-runner-${RUNNER_INDEX}"
          echo "test_name=$NAME" >> $GITHUB_OUTPUT
          echo "✅ Test Name: $NAME"

      # ---------------------------------------------------------------
      # 🧹 Step 5: Cleanup Old Reports (cleanup mode only)
      # ---------------------------------------------------------------
      - name: 🧹 Cleanup Old Reports
        if: ${{ github.event.inputs.test_type == 'cleanup' }}
        run: |
          echo "🧺 Deleting reports older than ${{ github.event.inputs.cleanup_days }} days..."
          find "${{ env.REPORT_DIR }}" -type f -mtime +${{ github.event.inputs.cleanup_days }} -print -delete || true
          echo "✅ Cleanup complete."

      - name: 💤 Skip Execution in Cleanup Mode
        if: ${{ github.event.inputs.test_type == 'cleanup' }}
        run: echo "Cleanup done. Skipping Artillery execution."

      # ---------------------------------------------------------------
      # 🚀 Step 6: Run Artillery Load/Stress Test
      # ---------------------------------------------------------------
      - name: 🚀 Run Artillery Test
        if: ${{ github.event.inputs.test_type != 'cleanup' }}
        shell: bash
        run: |
          mkdir -p "${{ env.REPORT_DIR }}"
          REPORT_JSON="${{ env.REPORT_DIR }}/${{ steps.set_name.outputs.test_name }}.json"
          REPORT_HTML="${{ env.REPORT_DIR }}/${{ steps.set_name.outputs.test_name }}.html"

          echo "▶️ Running Artillery test script: ${{ github.event.inputs.script_file }} (Runner ${{ matrix.runner_index }})"
          echo "🌍 Target URL: ${{ vars.BASE_URL }}"

          ARTILLERY_TARGET="${{ vars.BASE_URL }}" \
          API_KEY="${{ secrets.API_KEY }}" \
          AUTH_HEADER="${{ secrets.AUTH_HEADER }}" \
          npx artillery run "${{ env.SCRIPTS_DIR }}/${{ github.event.inputs.script_file }}" \
          --output "$REPORT_JSON" --quiet

          # Generate standard Artillery HTML report
          npx artillery report "$REPORT_JSON" --output "$REPORT_HTML"

      # ---------------------------------------------------------------
      # 🐍 Step 7: Setup Python and Generate Advanced Dashboard
      # ---------------------------------------------------------------
      - name: 🐍 Setup Python
        if: ${{ github.event.inputs.test_type != 'cleanup' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: 📦 Install Python Dependencies
        if: ${{ github.event.inputs.test_type != 'cleanup' }}
        run: |
          python -m pip install --upgrade pip
          pip install pandas pyyaml plotly numpy

      - name: 🧮 Generate Full HTML Dashboard
        if: ${{ github.event.inputs.test_type != 'cleanup' }}
        run: |
          echo "📊 Running custom Python report generator..."
          cp "${{ env.SCRIPTS_DIR }}/${{ github.event.inputs.script_file }}" config.yml
          python generate_artillery_dashboard.py
        env:
          INPUT_JSON: "${{ env.REPORT_DIR }}/${{ steps.set_name.outputs.test_name }}.json"
          INPUT_YAML: "config.yml"
          OUTPUT_HTML: "${{ env.REPORT_DIR }}/${{ steps.set_name.outputs.test_name }}-full.html"

      # ---------------------------------------------------------------
      # 📦 Step 8: Package and Upload Artifacts
      # ---------------------------------------------------------------
      - name: 📦 Package Results
        if: ${{ github.event.inputs.test_type != 'cleanup' }}
        run: |
          ZIP_FILE="${{ env.REPORT_DIR }}/${{ steps.set_name.outputs.test_name }}.zip"
          zip -j "$ZIP_FILE" \
            "${{ env.SCRIPTS_DIR }}/${{ github.event.inputs.script_file }}" \
            "${{ env.REPORT_DIR }}/${{ steps.set_name.outputs.test_name }}.json" \
            "${{ env.REPORT_DIR }}/${{ steps.set_name.outputs.test_name }}.html" \
            "${{ env.REPORT_DIR }}/${{ steps.set_name.outputs.test_name }}-full.html"
          echo "✅ Packaged results: $ZIP_FILE"

      - name: 📤 Upload Artifact
        if: ${{ github.event.inputs.test_type != 'cleanup' }}
        uses: actions/upload-artifact@v4
        with:
          name: "${{ steps.set_name.outputs.test_name }}"
          path: "${{ env.REPORT_DIR }}/${{ steps.set_name.outputs.test_name }}.zip"
