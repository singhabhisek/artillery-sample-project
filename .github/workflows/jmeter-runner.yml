name: "JMeter Load Test (Multi-Runner)"

run-name: >
  JMeter Workflow: ${{ github.event.inputs.test_name }}

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: "Choose test type (e.g., load/cleanup)"
        required: true
        type: choice
        options:
          - load
          - cleanup
      runners_to_use:
        description: "Number of parallel runners to use (1â€“4)"
        required: true
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '4'
      test_plan_file:
        description: "JMeter Test Plan (.jmx file)"
        required: true
        default: "High_TPS_Runner.jmx"
      test_name:
        description: "Optional test name; if blank, YYYYMMDD will be used"
        required: false
        default: ""
      run_name:
        description: "Optional custom run name; overrides test_name if provided"
        required: false
        default: ""
      monitor_system:
        description: "Monitor runner CPU/memory usage during test? true/false"
        required: false
        type: choice
        options:
          - "true"
          - "false"
        default: "false"
      cleanup_days:
        description: "Delete reports older than X days (cleanup mode)"
        required: false
        default: "7"
      print_machine_info:
        description: "Set true to print machine details"
        required: false
        type: choice
        options:
          - "true"
          - "false"

env:
  JMETER_VERSION: "5.6.3"
  JMETER_PLUGINS_MANAGER_VERSION: "1.8"
  SCRIPTS_DIR: "./scripts"
  REPORT_DIR: "./jmeter-results"

# =========================================================
# Pre-step: Determine final test name
# =========================================================
jobs:
  set-test-name:
    runs-on: ubuntu-latest
    outputs:
      final_test_name: ${{ steps.determine.outputs.final_test_name }}

    steps:
      - id: determine
        run: |
          TIMESTAMP=$(date +%Y%m%d)
          if [ -n "${{ github.event.inputs.run_name }}" ]; then
            FINAL_NAME="${{ github.event.inputs.run_name }}"
          elif [ -n "${{ github.event.inputs.test_name }}" ]; then
            FINAL_NAME="${{ github.event.inputs.test_name }}"
          else
            FINAL_NAME="test-$TIMESTAMP"
          fi
          echo "final_test_name=$FINAL_NAME" >> $GITHUB_OUTPUT

# =========================================================
# Main JMeter Runner Job
# =========================================================
  run-jmeter:
    name: ${{ needs.set-test-name.outputs.final_test_name }} - Runner ${{ matrix.runner_index }}
    runs-on: ubuntu-latest
    needs: [set-test-name]

    strategy:
      fail-fast: false
      matrix:
        runner_index: [1, 2, 3, 4]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Print machine details
        if: ${{ github.event.inputs.print_machine_info == 'true' }}
        run: |
          echo "===== Machine Info ====="
          echo "CPU cores: $(nproc)"
          echo "Memory: $(free -h)"
          echo "IP: $(curl -s ifconfig.me)"
          curl -s https://ipapi.co/json/
          echo "========================"

      - name: Skip unused runners
        if: ${{ matrix.runner_index > fromJSON(github.event.inputs.runners_to_use) }}
        run: |
          echo "Skipping runner ${{ matrix.runner_index }}"
          exit 0

      # -------------------------------
      # Install Java, JMeter, Plugins
      # -------------------------------
      - name: Install Java & JMeter with Plugins
        if: ${{ matrix.runner_index <= fromJSON(github.event.inputs.runners_to_use) }}
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq openjdk-17-jdk wget unzip

          # Download JMeter
          wget -nv https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-${{ env.JMETER_VERSION }}.zip
          unzip -q apache-jmeter-${{ env.JMETER_VERSION }}.zip

          JMETER_HOME="$PWD/apache-jmeter-${{ env.JMETER_VERSION }}"

          # Download Plugins Manager
          wget -nv https://jmeter-plugins.org/get/ -O $JMETER_HOME/lib/ext/jmeter-plugins-manager-${{ env.JMETER_PLUGINS_MANAGER_VERSION }}.jar

          # Download CMD tool for plugin install
          wget -nv https://jmeter-plugins.org/files/JMeterPluginsCMD-latest.zip
          unzip -q JMeterPluginsCMD-latest.zip -d $JMETER_HOME/lib/ext

          # Add Plugins Manager command line tool
          java -cp "$JMETER_HOME/lib/ext/jmeter-plugins-manager-${{ env.JMETER_PLUGINS_MANAGER_VERSION }}.jar" org.jmeterplugins.repository.PluginManagerCMDInstaller

          # Install essential plugins
          $JMETER_HOME/bin/PluginsManagerCMD.sh install \
            jpgc-dummy \
            jpgc-casutg \
            jpgc-filterresults \
            jpgc-graphs-basic \
            jpgc-graphs-additional \
            jpgc-json \
            jpgc-tst \
            jpgc-perfmon

          export PATH=$PATH:$JMETER_HOME/bin
          jmeter --version

      # -------------------------------
      # Verify JMX existence
      # -------------------------------
      - name: Check JMeter test plan exists
        run: |
          if [ ! -f "${{ env.SCRIPTS_DIR }}/${{ github.event.inputs.test_plan_file }}" ]; then
            echo "Test plan not found!"
            exit 1
          fi
          echo "Found test plan: ${{ env.SCRIPTS_DIR }}/${{ github.event.inputs.test_plan_file }}"

      # -------------------------------
      # Run JMeter Test
      # -------------------------------
      - name: Run JMeter test plan
        id: run_test
        run: |
          JMETER_HOME="$PWD/apache-jmeter-${{ env.JMETER_VERSION }}"
          TEST_NAME="${{ needs.set-test-name.outputs.final_test_name }}"
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          RESULT_DIR="${{ env.REPORT_DIR }}/${TEST_NAME}-runner-${{ matrix.runner_index }}-$TIMESTAMP"
          mkdir -p "$RESULT_DIR"

          echo "Running JMeter Test on Runner ${{ matrix.runner_index }}..."
          $JMETER_HOME/bin/jmeter -n \
            -t "${{ env.SCRIPTS_DIR }}/${{ github.event.inputs.test_plan_file }}" \
            -l "$RESULT_DIR/results.jtl" \
            -JerrorLogFile="$RESULT_DIR/error-results.jtl" \
            -JerrorLogDir="$RESULT_DIR" \
            -e -o "$RESULT_DIR/html-report" \
            -Jjmeter.save.saveservice.autoflush=true

          echo "result_dir=$RESULT_DIR" >> $GITHUB_OUTPUT

      # -------------------------------
      # Package & Upload Runner Artifacts
      # -------------------------------
      - name: Package results
        if: always()
        run: |
          ZIP_NAME="runner-${{ matrix.runner_index }}-results.zip"
          mkdir -p upload
          zip -r "upload/$ZIP_NAME" "${{ steps.run_test.outputs.result_dir }}" -i "*.jtl" -i "*.log" -i "*.csv" -i "*.txt" -i "*/html-report/*"
          echo "Packaged: upload/$ZIP_NAME"

      - name: Upload runner artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-results-runner-${{ matrix.runner_index }}
          path: upload/*.zip

# =========================================================
# Aggregate Reports
# =========================================================
  aggregate-reports:
    if: ${{ github.event.inputs.test_type != 'cleanup' }}
    needs: [set-test-name, run-jmeter]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all runner artifacts
        uses: actions/download-artifact@v4
        with:
          path: jmeter-results

      - name: Extract all ZIPs
        run: |
          mkdir -p combined-results
          for zipfile in jmeter-results/**/*.zip; do
            [ -f "$zipfile" ] || continue
            folder=$(basename "$zipfile" .zip)
            mkdir -p combined-results/"$folder"
            unzip -q "$zipfile" -d combined-results/"$folder"
          done

      - name: Merge JTL and Error Logs
        run: |
          mkdir -p consolidated
          find combined-results -type f -name "results.jtl" -exec cat {} + > consolidated/merged-results.jtl
          find combined-results -type f -name "error-results.jtl" -exec cat {} + > consolidated/merged-errors.jtl
          find combined-results -type f -name "custom-errors.log" -exec cat {} + > consolidated/merged-custom-errors.log || true

      - name: Generate consolidated HTML report
        run: |
          wget -nv https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-${{ env.JMETER_VERSION }}.zip
          unzip -q apache-jmeter-${{ env.JMETER_VERSION }}.zip
          apache-jmeter-${{ env.JMETER_VERSION }}/bin/jmeter -g consolidated/merged-results.jtl -o consolidated/html-report
          apache-jmeter-${{ env.JMETER_VERSION }}/bin/jmeter -g consolidated/merged-errors.jtl -o consolidated/html-errors-report || true

      - name: Package and upload consolidated results
        if: always()
        run: |
          zip -r consolidated-results.zip consolidated/
        uses: actions/upload-artifact@v4
        with:
          name: consolidated-jmeter-results
          path: consolidated-results.zip
